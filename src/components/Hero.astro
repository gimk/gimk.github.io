---
import { SITE, SOCIALS, NEW_PROJECT } from "@consts";
import Link from "@components/Link.astro";
import ExperienceCounter from "@components/ExperienceCounter.astro";
---

<div class="shadow-ascii">
  <section
    class="min-h-[600px] flex flex-col md:flex-row border border-black/10 dark:border-white/10 bg-orange-50 dark:bg-slate-950 relative mb-24"
  >
  <!-- Left Side: Intro Content -->
  <div
    class="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center z-10 border-b md:border-b-0 md:border-r border-black/10 dark:border-white/10 relative items-start"
  >
    <!-- Project Pill -->
    <div class="mb-6 flex animate">
      <div class="rounded-full bg-orange-50 dark:bg-slate-950 hover:bg-black/5 dark:hover:bg-white/5 transition-colors duration-300">
        <a
          href={NEW_PROJECT.HREF}
          target="_blank"
          rel="noopener noreferrer"
          class="relative flex flex-nowrap items-center justify-center gap-3 px-3 py-2 border border-black/10 dark:border-white/10 sm:hover:text-black dark:sm:hover:text-white transition-all duration-300 ease-in-out overflow-hidden rounded-full font-sans group"
        >
          <div class="flex items-center gap-2">
            <svg width="16" height="16" viewBox="12.7 17.8 37 37" xmlns="http://www.w3.org/2000/svg" class="text-accent-primary" fill="currentColor">
              <path d="M 31.2344 54.7305 C 31.8438 54.7305 32.2891 54.2852 32.4062 53.6524 C 34.0703 40.8086 35.8750 38.8633 48.5781 37.4570 C 49.2344 37.3867 49.6797 36.8945 49.6797 36.2852 C 49.6797 35.6758 49.2344 35.2070 48.5781 35.1133 C 35.8750 33.7070 34.0703 31.7617 32.4062 18.9180 C 32.2891 18.2852 31.8438 17.8633 31.2344 17.8633 C 30.6250 17.8633 30.1797 18.2852 30.0860 18.9180 C 28.4219 31.7617 26.5938 33.7070 13.9140 35.1133 C 13.2344 35.2070 12.7891 35.6758 12.7891 36.2852 C 12.7891 36.8945 13.2344 37.3867 13.9140 37.4570 C 26.5703 39.1211 28.3281 40.8321 30.0860 53.6524 C 30.1797 54.2852 30.6250 54.7305 31.2344 54.7305 Z"/>
            </svg>
            <div class="font-regular text-sm whitespace-nowrap z-10">
              Check out my last project
            </div>
          </div>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            class="size-5 stroke-2 fill-none stroke-current group-hover:stroke-accent-primary transition-colors duration-300 z-10"
          >
            <line
              x1="5"
              y1="12"
              x2="19"
              y2="12"
              class="translate-x-3 sm:group-hover:translate-x-0 scale-x-0 sm:group-hover:scale-x-100 transition-transform duration-300 ease-in-out"
            ></line>
            <polyline
              points="12 5 19 12 12 19"
              class="-translate-x-1 sm:group-hover:translate-x-0 transition-transform duration-300 ease-in-out"
            ></polyline>
          </svg>
        </a>
      </div>
    </div>

    <div class="flex items-center">
      <h1
        class="animate font-semibold text-black dark:text-white tracking-wider text-3xl"
      >
        Hi, I'm Antoine <span class="text-3xl normal-case">üëã</span>
      </h1>
    </div>

    <article class="space-y-6 mt-2">
      <p class="animate text-lg">
        I am a passionate <b>Senior Product Designer</b>, with a strong
        engineering background and <ExperienceCounter /> of experience in product and design.
      </p>
      <p class="animate text-sm opacity-80 font-serif leading-relaxed">
        A few years back, I decided to dedicate my time to merge design and
        engineering and create clear, simple, and meaningful <b>user systems</b
        >, that overperform without compromising the experience.
      </p>
      <p class="animate text-sm opacity-80 font-serif leading-relaxed">
        Beyond design, I'm a passionate <b>photographer</b>, and lately I have been spending a lot of my time <b>vibe coding</b>. I'm also a definitive foodie, have been cooking for years, and recently passed a French culinary license! üßë‚Äçüç≥
      </p>
    </article>

    <div class="animate pt-10 space-y-4">
      <h5 class="section-title">
        Connect
      </h5>
      <ul class="flex flex-wrap gap-x-4 gap-y-2 text-sm">
        {
          SOCIALS.map((SOCIAL) => (
            <li>
              <span class="flex items-center gap-x-2">
                <Link
                  href={SOCIAL.HREF}
                  external
                  aria-label={`${SITE.NAME} on ${SOCIAL.NAME}`}
                >
                  {SOCIAL.NAME}
                </Link>
                <span class="opacity-20">/</span>
              </span>
            </li>
          ))
        }
        <li class="line-clamp-1">
          <Link href={`mailto:${SITE.EMAIL}`} aria-label={`Email ${SITE.NAME}`}>
            {SITE.EMAIL}
          </Link>
        </li>
      </ul>
    </div>
  </div>

  <!-- Right Side: Contained ASCII Animation -->
  <div
    id="hero-ascii-container"
    class="w-full md:w-1/2 h-[400px] md:h-auto relative overflow-hidden bg-black/[0.02] dark:bg-white/[0.02] flex items-center justify-center cursor-crosshair"
  >
    <pre
      id="hero-ascii"
      aria-hidden="true"
      class="hero-ascii-text">
    </pre>
  </div>
  </section>
</div>
<script>
  let frameId: number;
  let lastTime = 0;
  const FPS_LIMIT = 24;
  const FRAME_MIN_TIME = 1000 / FPS_LIMIT;

  function initHeroAscii() {
    const canvas = document.getElementById(
      "hero-ascii",
    ) as HTMLPreElement | null;
    const container = document.getElementById("hero-ascii-container");
    if (!canvas || !container) return;

    // Stop any existing animation
    if (frameId) {
      cancelAnimationFrame(frameId);
    }

    const density = " .:-=+*#%@";
    // Restored original grid size for high-density look
    const cols = 200;
    const rows = 100;
    let time = 0;
    let isVisible = true;

    // Mouse tracking for trail
    let mouseX = -1000;
    let mouseY = -1000;
    const trailPoints: {
      x: number;
      y: number;
      age: number;
      char: string;
      vx?: number;
      vy?: number;
    }[] = [];
    const trailChars = "@#%*+=-:. ";

    // Pause when not in view
    const observer = new IntersectionObserver(
      ([entry]) => {
        isVisible = entry.isIntersecting;
      },
      { threshold: 0 },
    );
    observer.observe(container);

    function addPoint(x: number, y: number, age = 1.0, vx = 0, vy = 0) {
      trailPoints.push({
        x,
        y,
        age,
        char: trailChars[Math.floor(Math.random() * trailChars.length)],
        vx,
        vy,
      });
      if (trailPoints.length > 200) trailPoints.shift();
    }

    container.addEventListener("mousemove", (e) => {
      const rect = canvas.getBoundingClientRect();
      mouseX = ((e.clientX - rect.left) / rect.width) * cols;
      mouseY = ((e.clientY - rect.top) / rect.height) * rows;
      addPoint(mouseX, mouseY);
    });

    container.addEventListener("mousedown", (e) => {
      const rect = canvas.getBoundingClientRect();
      const cx = ((e.clientX - rect.left) / rect.width) * cols;
      const cy = ((e.clientY - rect.top) / rect.height) * rows;

      // Create star burst
      const numParticles = 8;
      for (let i = 0; i < numParticles; i++) {
        const angle = (i / numParticles) * Math.PI * 2;
        const speed = 0.5 + Math.random() * 0.5;
        addPoint(cx, cy, 1.2, Math.cos(angle) * speed, Math.sin(angle) * speed);
      }
    });

    container.addEventListener("mouseleave", () => {
      mouseX = -1000;
      mouseY = -1000;
    });

    function render(timestamp: number) {
      if (!isVisible) {
        frameId = requestAnimationFrame(render);
        return;
      }

      // Throttle FPS
      const elapsed = timestamp - lastTime;
      if (elapsed < FRAME_MIN_TIME) {
        frameId = requestAnimationFrame(render);
        return;
      }
      lastTime = timestamp;

      const cx = cols / 2;
      const cy = rows / 2;

      // Update trail ages and positions
      for (let i = 0; i < trailPoints.length; i++) {
        const point = trailPoints[i];
        point.age -= 0.02; // Age faster due to lower FPS

        if (point.vx !== undefined && point.vy !== undefined) {
          point.x += point.vx;
          point.y += point.vy;
          point.vx *= 0.94;
          point.vy *= 0.94;
        }

        const tdx = point.x - cx;
        const tdy = point.y - cy;
        const dist = Math.sqrt(tdx * tdx + tdy * tdy);
        if (dist > 0) {
          point.x += (tdx / dist) * 0.15;
          point.y += (tdy / dist) * 0.15;
        }
      }
      
      while (trailPoints.length > 0 && trailPoints[0].age <= 0) {
        trailPoints.shift();
      }

      const grid: string[][] = [];
      const radiusSq = 2.5 * 2.5;

      for (let y = 0; y < rows; y++) {
        grid[y] = [];
        for (let x = 0; x < cols; x++) {
          const dx = (x - cx) * 0.875;
          const dy = y - cy;
          const distance = Math.sqrt(dx * dx + dy * dy);

          const wave =
            Math.sin(distance * 0.12 - time) * 0.6 +
            Math.cos(dx * 0.08 + time * 0.5) * 0.2 +
            Math.sin(dy * 0.08 + time * 0.5) * 0.2;

          // Optimized trail influence
          let trailInfluence = 0;
          for (const point of trailPoints) {
            const adx = Math.abs(x - point.x) * 0.875;
            const ady = Math.abs(y - point.y);
            
            // Skip expensive sqrt if outside bounding box
            if (adx < 2.5 && ady < 2.5) {
                const tdistSq = adx * adx + ady * ady;
                if (tdistSq < radiusSq) {
                    trailInfluence += (1 - Math.sqrt(tdistSq) / 2.5) * point.age * 0.5;
                }
            }
          }

          const normalized = (wave + 1) / 2 + trailInfluence;
          let charIndex = Math.floor(normalized * density.length);
          charIndex = Math.max(0, Math.min(density.length - 1, charIndex));
          grid[y][x] = density[charIndex];
        }
      }

      for (const point of trailPoints) {
        const px = Math.floor(point.x);
        const py = Math.floor(point.y);
        if (px >= 0 && px < cols && py >= 0 && py < rows) {
          if (Math.random() < point.age * 0.5) {
            grid[py][px] = point.char;
          }
        }
      }

      const output = grid.map((row) => row.join("")).join("\n");
      if (canvas) canvas.textContent = output;
      
      time += 0.02; // Faster increment for lower FPS
      frameId = requestAnimationFrame(render);
    }

    frameId = requestAnimationFrame(render);
    return () => cancelAnimationFrame(frameId);
  }

  // Initialize
  initHeroAscii();
  document.addEventListener("astro:after-swap", initHeroAscii);
</script>
