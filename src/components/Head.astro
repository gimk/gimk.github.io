---
// Import global styles and fonts
import "../styles/global.css";
import "@fontsource/dm-sans/latin-400.css";
import "@fontsource/dm-sans/latin-500.css";
import "@fontsource/fraunces/latin-400.css";
import "@fontsource/fraunces/latin-600.css";
import "@fontsource/jetbrains-mono/latin-400.css";
import "@fontsource/jetbrains-mono/latin-600.css";
import { ClientRouter } from "astro:transitions";
// Deprecated : import { ViewTransitions } from "astro:transitions";

// Define component props
interface Props {
  title: string;
  description: string;
  image?: string;
}

// Determine the canonical URL
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// Destructure props with default image
const { title, description, image = "/nano.png" } = Astro.props;
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<link
  rel="icon"
  type="image/svg+xml"
  href="/favicon-dark.svg"
  media="(prefers-color-scheme: dark)"
/>
<link
  rel="icon"
  type="image/svg+xml"
  href="/favicon-light.svg"
  media="(prefers-color-scheme: light)"
/>

<meta name="generator" content={Astro.generator} />
<meta name="theme-color" />

<link rel="canonical" href={canonicalURL} />

<link rel="sitemap" href="/sitemap-index.xml" />

<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(image, Astro.url)} />

<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(image, Astro.url)} />

<ClientRouter />

<script>
  // This script runs only once on initial load for View Transitions
  import type { TransitionBeforeSwapEvent } from "astro:transitions/client";
  import { initPigAnimation } from "../scripts/pig-animation";
  
  document.addEventListener("astro:before-swap", (e) =>
    [
      // Select all font preload links in the incoming document's head
      ...(e as TransitionBeforeSwapEvent).newDocument.head.querySelectorAll(
        "link[as=\"font\"]"
      ),
      // Remove each found link to prevent duplicate preloading issues
    ].forEach((link) => link.remove())
  );

  document.addEventListener("DOMContentLoaded", initPigAnimation);
  document.addEventListener("astro:after-swap", initPigAnimation);
</script>

<script is:inline>
  // Function to add 'show' class to elements for staggered animation
  function animate() {
    const animateElements = document.querySelectorAll(".animate");
    animateElements.forEach((element, index) => {
      setTimeout(() => {
        element.classList.add("show");
      }, index * 150); // Stagger animation start time
    });
  }

  // Function to add/remove 'scrolled' class based on scroll position
  function onScroll() {
    if (window.scrollY > 0) {
      document.documentElement.classList.add("scrolled");
    } else {
      document.documentElement.classList.remove("scrolled");
    }
  }

  // Function to smoothly scroll the page to the top
  function scrollToTop(event) {
    event.preventDefault(); // Prevent default link behavior
    window.scrollTo({
      top: 0,
      behavior: "smooth", // Enable smooth scrolling
    });
  }

  // Function to toggle dark/light theme instantly (avoids transition flicker)
  function toggleTheme(dark, disableTransitions = true) {
    let css = null;
    if (disableTransitions) {
      // Create a temporary style element to disable all transitions
      css = document.createElement("style");
      css.appendChild(
        document.createTextNode(
          `*:not(.sun-moon, .sun-moon *, .sun-core, .sun-beams, .moon-mask, .moon-mask *) {
             -webkit-transition: none !important;
             -moz-transition: none !important;
             -o-transition: none !important;
             -ms-transition: none !important;
             transition: none !important;
          }`
        )
      );
      document.head.appendChild(css);
    }

    // Add or remove the 'dark' class from the root element
    if (dark) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }

    if (disableTransitions) {
      // Force browser reflow to apply changes immediately before removing the style override
      window.getComputedStyle(css).opacity;
      document.head.removeChild(css);
    }
  }

  // Function to apply the theme based on localStorage or system preference on initial load
  function preloadTheme() {
    const userTheme = localStorage.theme;
    const themeColorMeta = document.querySelector("meta[name=\"theme-color\"]");
    // Determine if dark mode should be enabled
    const isDark =
      userTheme === "dark" ||
      (userTheme !== "light" && // Check if no explicit light theme is set
        window.matchMedia("(prefers-color-scheme: dark)").matches); // Check system preference
    toggleTheme(isDark); // Apply the theme
    // Update the theme-color meta tag for browser UI consistency
    if (themeColorMeta) {
      themeColorMeta.setAttribute("content", isDark ? "#020617" : "#fff7ed");
    }
  }

  // --- Main Initialization function ---
  // This function sets up event listeners and starts animations.
  // It's called on initial load and after Astro view transitions.
  function init() {
    console.log("Running init()..."); // Log init execution for debugging

    // --- Initial Setup: Theme, Scroll Behavior, Entry Animations ---
    preloadTheme(); // Set the theme immediately
    onScroll(); // Check initial scroll position
    animate(); // Start entry animations

    // --- Event Listener Setup ---

    // Back to Top Button
    const backToTop = document.getElementById("back-to-top");
    // Remove existing listener to prevent duplicates on swaps, then add it
    backToTop?.removeEventListener("click", scrollToTop);
    backToTop?.addEventListener("click", scrollToTop); // Use named function directly

    // Back to Previous Page Button (e.g., on a blog post)
    const backToPrev = document.getElementById("back-to-prev");
    // Add listener only if it hasn't been added before (using a data attribute)
    if (backToPrev && !backToPrev.hasAttribute("data-listener-added")) {
      backToPrev.addEventListener("click", () => window.history.back());
      backToPrev.setAttribute("data-listener-added", "true"); // Mark as added
    }

    // Theme Toggle Button
    const themeColorMeta = document.querySelector("meta[name=\"theme-color\"]");
    const toggleThemeButton = document.getElementById("theme-button");
    // Add listener only if it hasn't been added before
    if (
      toggleThemeButton &&
      !toggleThemeButton.hasAttribute("data-listener-added")
    ) {
      toggleThemeButton.addEventListener("click", () => {
        const isDark = document.documentElement.classList.contains("dark");
        if (isDark) {
          // Switch to light theme
          localStorage.setItem("theme", "light");
          themeColorMeta?.setAttribute("content", "#fff7ed");
          toggleTheme(false, true);
        } else {
          // Switch to dark theme
          localStorage.setItem("theme", "dark");
          themeColorMeta?.setAttribute("content", "#020617");
          toggleTheme(true, true);
        }
      });
      toggleThemeButton.setAttribute("data-listener-added", "true"); // Mark as added
    }

    // Scroll Listener for header styling changes
    // Remove existing listener before adding to prevent duplicates
    document.removeEventListener("scroll", onScroll);
    document.addEventListener("scroll", onScroll);

  } // --- End of init() function ---

  // --- Initial Page Load and Astro Navigation Hooks ---
  // Run init() when the DOM is fully loaded initially
  document.addEventListener("DOMContentLoaded", init);
  // Run init() after Astro swaps content during view transitions
  document.addEventListener("astro:after-swap", init);
  // Preload theme on initial load (before DOMContentLoaded potentially)
  // This helps prevent flashing of the wrong theme
  preloadTheme();
</script>
